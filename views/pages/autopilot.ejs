<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Autopilot Job Search and Persona Creation</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary-color: #2196f3;
        --primary-light: #bbdefb;
        --primary-dark: #1976d2;
        --secondary-color: #ffc107;
        --text-color: #333333;
        --background-color: #f5f7fa;
        --card-background: #ffffff;
        --success-color: #4caf50;
        --error-color: #f44336;
        --border-radius: 12px;
        --box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      }

      body,
      html {
        font-family: "Poppins", Arial, sans-serif;
        background-color: var(--background-color);
        color: var(--text-color);
        line-height: 1.6;
        margin: 0;
        padding: 0;
      }

      .container {
        max-width: 800px;
        margin: 40px auto;
        padding: 40px;
        background-color: var(--card-background);
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
      }

      h1 {
        font-size: 2.5em;
        text-align: center;
        color: var(--primary-dark);
        margin-bottom: 40px;
        position: relative;
        padding-bottom: 15px;
      }

      h1::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 100px;
        height: 4px;
        background-color: var(--secondary-color);
      }

      .input-group {
        margin-bottom: 25px;
      }

      .input-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--primary-dark);
      }

      .input-group input,
      .input-group select {
        width: 100%;
        padding: 12px;
        border: 2px solid var(--primary-light);
        border-radius: var(--border-radius);
        font-size: 16px;
        transition: var(--transition);
      }

      .input-group input:focus,
      .input-group select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px var(--primary-light);
      }

      .designation-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
      }

      .designation-tag {
        background-color: var(--primary-light);
        color: var(--primary-dark);
        padding: 8px 15px;
        border-radius: 20px;
        display: flex;
        align-items: center;
        font-size: 14px;
        font-weight: 500;
        transition: var(--transition);
      }

      .designation-tag:hover {
        background-color: var(--primary-color);
        color: white;
      }

      .designation-tag .remove {
        margin-left: 8px;
        cursor: pointer;
        font-weight: bold;
      }

      .btn {
        display: inline-block;
        padding: 12px 25px;
        background: linear-gradient(
          45deg,
          var(--primary-color),
          var(--primary-dark)
        );
        color: white;
        text-decoration: none;
        border-radius: 30px;
        transition: var(--transition);
        text-align: center;
        font-size: 1.1em;
        font-weight: 600;
        border: none;
        cursor: pointer;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        width: 100%;
        margin-top: 20px;
      }

      .btn:hover {
        background: linear-gradient(
          45deg,
          var(--primary-dark),
          var(--primary-color)
        );
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
      }

      #status {
        margin-top: 30px;
        padding: 15px;
        border-radius: var(--border-radius);
        background-color: var(--primary-light);
        color: var(--primary-dark);
        font-weight: 500;
        text-align: center;
      }

      .progress-bar {
        margin-top: 20px;
        width: 100%;
        background-color: var(--primary-light);
        border-radius: 10px;
        overflow: hidden;
      }

      .progress {
        width: 0%;
        height: 10px;
        background: linear-gradient(
          45deg,
          var(--primary-color),
          var(--primary-dark)
        );
        transition: width 0.5s ease;
      }

      @media screen and (max-width: 768px) {
        .container {
          padding: 20px;
          margin: 20px;
        }

        h1 {
          font-size: 2em;
        }

        .btn {
          padding: 10px 20px;
          font-size: 1em;
        }
      }
.or-separator {
  text-align: center;
  margin: 20px 0;
  position: relative;
}

.or-separator::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 0;
  width: 45%;
  border-top: 1px solid #ccc;
}

.or-separator::after {
  content: '';
  position: absolute;
  top: 50%;
  right: 0;
  width: 45%;
  border-top: 1px solid #ccc;
}
.checkbox-group {
        margin-bottom: 20px;
      }
      
      .checkbox-group label {
        display: flex;
        align-items: center;
        font-weight: 500;
        color: var(--primary-dark);
        cursor: pointer;
        transition: var(--transition);
      }
      
      .checkbox-group input[type="checkbox"] {
        appearance: none;
        width: 20px;
        height: 20px;
        border: 2px solid var(--primary-light);
        border-radius: 4px;
        margin-right: 10px;
        position: relative;
        transition: var(--transition);
      }
      
      .checkbox-group input[type="checkbox"]:checked {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
      }
      
      .checkbox-group input[type="checkbox"]:checked::before {
        content: "✔";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 14px;
      }
      
      .checkbox-group label:hover {
        color: var(--primary-color);
      }
      
      .checkbox-group input[type="checkbox"]:focus {
        outline: none;
        box-shadow: 0 0 0 3px var(--primary-light);
      }
      .checkbox-group-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 30px;
      }
      
      .checkbox-group {
        flex: 1;
        padding: 20px;
        border-radius: var(--border-radius);
        background-color: var(--card-background);
        box-shadow: var(--box-shadow);
        transition: var(--transition);
      }
      
      .checkbox-group:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
      }
      
      .checkbox-group label {
        display: flex;
        align-items: center;
        font-weight: 600;
        color: var(--primary-dark);
        cursor: pointer;
        transition: var(--transition);
      }
      
      .checkbox-group input[type="checkbox"] {
        appearance: none;
        width: 24px;
        height: 24px;
        border: 2px solid var(--primary-light);
        border-radius: 6px;
        margin-right: 12px;
        position: relative;
        transition: var(--transition);
      }
      
      .checkbox-group input[type="checkbox"]:checked {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
      }
      
      .checkbox-group input[type="checkbox"]:checked::before {
        content: "✔";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 16px;
      }
      
      .checkbox-group label:hover {
        color: var(--primary-color);
      }
      
      .checkbox-group input[type="checkbox"]:focus {
        outline: none;
        box-shadow: 0 0 0 4px var(--primary-light);
      }
      
      .checkbox-group span {
        font-size: 1.1em;
      }
       .industry-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
      }

      .industry-tag {
        background-color: var(--primary-light);
        color: var(--primary-dark);
        padding: 8px 15px;
        border-radius: 20px;
        display: flex;
        align-items: center;
        font-size: 14px;
        font-weight: 500;
        transition: var(--transition);
      }

      .industry-tag:hover {
        background-color: var(--primary-color);
        color: white;
      }

      .industry-tag .remove {
        margin-left: 8px;
        cursor: pointer;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Autopilot entire process</h1>
      <form id="autopilotForm">
        <div class="input-group">
          <div class="input-group">
            <label for="scheduleTime">Schedule Time:</label>
            <input
              type="datetime-local"
              id="scheduleTime"
              name="scheduleTime"
              required
            />
          </div>
          <div class="input-group">
            <label for="jobTitle">Job Title Search:</label>
            <input
            type="text"
            id="jobTitle"
            name="jobTitle"
            placeholder="e.g., Backend Developer, Frontend Developer, Data Analyst"
            required
          />
          </div>
          <div class="or-separator">OR</div>
          <div class="input-group">
            <label for="job_function">Job Function:</label>
            <select id="job_function" name="job_function" multiple>
              <option value="" selected>Select a job function</option>
              <% jobFunctionArr.forEach(function(jobFunction) { %>
              <option value="<%= jobFunction.value %>">
                <%= jobFunction.label %>
              </option>
              <% }); %>
            </select>
            <div id="tag-container" class="tag-container"></div>
          </div>
          <div class="input-group">
            <label for="location">Location:</label>
            <input
              type="text"
              id="location"
              name="location"
              placeholder="Type a location"
              list="location-suggestions"
              data-value=""
              required
            />
            <datalist id="location-suggestions"></datalist>
            <input
              type="hidden"
              id="location_hidden"
              name="location_hidden"
              value=""
            />
          </div>
          <div class="input-group">
            <label for="num_jobs">Maximum number of Jobs:</label>
            <input
              type="number"
              id="num_jobs"
              name="num_jobs"
              min="1"
              max="100000"
              value="10000"
              required
            />
          </div>
          <div class="input-group">
            <label for="job_listed_date">Job Listed From:</label>
            <input
              type="datetime-local"
              id="job_listed_date"
              name="job_listed_date"
              placeholder="Select date and time"
              step="60"
              max="<%= new Date().toISOString().slice(0, 16) %>"
            />
          </div>
          <div class="or-separator">OR</div>
          <div class="input-group">
            <label for="job_listed_range">Job Listed Within:</label>
            <select id="job_listed_range" name="job_listed_range">
              <option value="" selected>Select a time range</option>
              <option value="24hours">Past 24 hours</option>
              <option value="48hours">Past 48 hours</option>
              <option value="week">Past week</option>
              <option value="month">Past month</option>
            </select>
          </div>
          <div class="input-group">
            <label for="industry">Industries:</label>
            <select id="industry" name="industry" multiple>
              <option value="" selected>Select an industry</option>
              <% industryArr.forEach(function(industry) { %>
              <option value="<%= industry %>"><%= industry %></option>
              <% }); %>
            </select>
            <div id="industry-tag-container" class="tag-container"></div>
          </div>
        <div class="input-group">
          <label for="searchLimit">Search Limit:</label>
          <input
            type="number"
            id="searchLimit"
            name="searchLimit"
            min="1"
            max="1000"
            value="100"
            required
          />
        </div>
        <div class="input-group">
          <label for="personaDesignations">Persona Designations:</label>
          <input
            type="text"
            id="personaDesignations"
            name="personaDesignations"
            placeholder="Type and press Enter to add"
          />
          <div id="designationTags" class="designation-tags"></div>
        </div>
        <div class="input-group">
          <label>Select Autopilot Steps:</label>
          <div class="checkbox-group">
            <label>
              <input type="checkbox" name="jobSearch" checked />
              <span>Job Search</span>
            </label>
          </div>
          <div class="checkbox-group">
            <label>
              <input type="checkbox" name="personaCreate" checked />
              <span>Persona Create</span>
            </label>
          </div>
          <div class="checkbox-group">
            <label>
              <input type="checkbox" name="emailReachout" checked />
              <span>Email Reachout</span>
            </label>
          </div>
        </div>
        <button id="startAutopilot" class="btn" type="submit">
          Start Autopilot
        </button>
      </form>
      <div id="status">Ready to start...</div>
      <div class="progress-bar">
        <span class="progress" id="progressBar"></span>
      </div>
    </div>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
          const form = document.getElementById('autopilotForm');
          const startButton = document.getElementById('startAutopilot');
          const statusDiv = document.getElementById('status');
          const progressBar = document.getElementById('progressBar');
          const personaDesignationsInput = document.getElementById('personaDesignations');
          const designationTagsContainer = document.getElementById('designationTags');
      
          let designations = [];
          const industryInput = document.getElementById('industry');
        const industryTagsContainer = document.getElementById('industryTags');
        const jobFunctionInput = document.getElementById('job_function');
        const jobFunctionTagsContainer = document.getElementById('jobFunctionTags');

        let jobFunctions = [];

        jobFunctionInput.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' || e.key === ',') {
            e.preventDefault();
            addTag(this.value.trim(), jobFunctions, jobFunctionTagsContainer);
            this.value = '';
          }
        });

        function addTag(value, array, container) {
          if (value && !array.includes(value)) {
            array.push(value);
            renderTags(array, container);
          }
        }

        function removeTag(value, array, container) {
          array = array.filter(item => item !== value);
          renderTags(array, container);
        }

        function renderTags(array, container) {
          container.innerHTML = '';
          array.forEach(item => {
            const tag = document.createElement('span');
            tag.classList.add('designation-tag');
            tag.innerHTML = `
              ${item}
              <span class="remove" data-value="${item}">&times;</span>
            `;
            container.appendChild(tag);
          });

          const removeButtons = container.querySelectorAll('.remove');
          removeButtons.forEach(button => {
            button.addEventListener('click', function() {
              const value = this.dataset.value;
              removeTag(value, array, container);
            });
          });
        }   personaDesignationsInput.addEventListener('keydown', function(e) {
              if (e.key === 'Enter' || e.key === ',') {
                  e.preventDefault();
                  addDesignation(this.value.trim());
                  this.value = '';
              }
          });
      
          function addDesignation(designation) {
              if (designation && !designations.includes(designation)) {
                  designations.push(designation);
                  renderDesignationTags();
              }
          }
      
          function removeDesignation(designation) {
    designations = designations.filter(d => d !== designation);
    renderDesignationTags();
}

function renderDesignationTags() {
    designationTagsContainer.innerHTML = '';
    designations.forEach(designation => {
        const tag = document.createElement('span');
        tag.classList.add('designation-tag');
        tag.innerHTML = `
            ${designation}
            <span class="remove" data-designation="${designation}">&times;</span>
        `;
        designationTagsContainer.appendChild(tag);
    });

    // Add event listener to remove buttons
    const removeButtons = designationTagsContainer.querySelectorAll('.remove');
    removeButtons.forEach(button => {
        button.addEventListener('click', function() {
            const designation = this.dataset.designation;
            removeDesignation(designation);
        });
    });
}

          form.addEventListener('submit', async function(e) {
              e.preventDefault();
              startButton.disabled = true;
              updateStatus('Scheduling autopilot process...');
              updateProgress(10);
      
              const formData = new FormData(form);
              formData.append('personaDesignations', designations.join(','));
      
              const autopilotSteps = Array.from(document.querySelectorAll('input[name="autopilotSteps"]:checked'))
                .map(checkbox => checkbox.value);
              formData.append('autopilotSteps', autopilotSteps.join(','));


              try {
                  const response = await fetch('/autopilot-search', {
                      method: 'POST',
                      body: formData
                  });
                  const result = await response.json();
      
                  if (result.success) {
                      updateStatus(`Autopilot process scheduled successfully. Request ID: ${result.reqId}`);
                      updateProgress(100);
                      startPolling(result.reqId);
                  } else {
                      throw new Error(result.error || 'Unknown error occurred');
                  }
              } catch (error) {
                  console.error('Error during autopilot process:', error);
                  updateStatus(`An error occurred: ${error.message}`);
                  startButton.disabled = false;
              }
          });
      
          function updateStatus(message) {
              statusDiv.textContent = message;
          }
      
          function updateProgress(percentage) {
              progressBar.style.width = `${percentage}%`;
          }
      
          function startPolling(reqId) {
              let pollCount = 0;
              const maxPolls = 60; // Poll for a maximum of 5 minutes (60 * 5 seconds)
              const pollInterval = 5000; // Poll every 5 seconds
      
              const poll = async () => {
                  try {
                      const response = await fetch(`/api/check-status/${reqId}`);
                      const result = await response.json();
      
                      if (result.completed) {
                          updateStatus('Autopilot process completed successfully!');
                          updateProgress(100);
                          // Provide links to view results
                          statusDiv.innerHTML += `<br><a href="/get-jobs/${reqId}">View Jobs</a> | <a href="/persona-reachout/${reqId}">View Personas</a>`;
                      } else {
                          updateStatus(`In progress... ${result.personaCount} personas created so far.`);
                          updateProgress(result.progress);
                          
                          if (pollCount < maxPolls) {
                              pollCount++;
                              setTimeout(poll, pollInterval);
                          } else {
                              updateStatus('Polling timed out. The process may still be running in the background.');
                          }
                      }
                  } catch (error) {
                      console.error('Error checking status:', error);
                      updateStatus('Error checking status. The process may still be running.');
                  }
              };
      
              poll();
          }
      
          // Initialize multi-select dropdowns
          const jobFunctionSelect = document.getElementById('job_function');
          const industrySelect = document.getElementById('industry');
      
          if (jobFunctionSelect) initializeMultiSelect(jobFunctionSelect);
          if (industrySelect) initializeMultiSelect(industrySelect);
      
          function initializeMultiSelect(selectElement) {
              const tagContainer = document.createElement('div');
              tagContainer.className = 'tag-container';
              selectElement.parentNode.insertBefore(tagContainer, selectElement.nextSibling);
      
              selectElement.addEventListener('change', updateTags);
      
              function updateTags() {
                  tagContainer.innerHTML = '';
                  const selectedOptions = Array.from(selectElement.selectedOptions);
                  selectedOptions.forEach(option => {
                      const tag = document.createElement('span');
                      tag.classList.add('tag');
                      tag.textContent = option.text;
                      const removeBtn = document.createElement('span');
                      removeBtn.textContent = ' ×';
                      removeBtn.classList.add('remove');
                      removeBtn.onclick = function() {
                          option.selected = false;
                          updateTags();
                      };
                      tag.appendChild(removeBtn);
                      tagContainer.appendChild(tag);
                  });
              }
          }
      });
      </script>
  </body>
</html>
