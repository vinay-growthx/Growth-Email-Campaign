<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Send Email</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdnjs.cloudflare.com/ajax/libs/trix/1.3.1/trix.css"
    />
    <style>
      body,
      html {
        font-family: "Poppins", Arial, sans-serif;
        background: linear-gradient(135deg, #f6f9fc 0%, #e9f2f9 100%);
        margin: 0;
        padding: 0;
        overflow-x: hidden;
        color: #333;
      }

      .parallax-container {
        perspective: 1px;
        height: 100vh;
        overflow-x: hidden;
        overflow-y: auto;
      }
      .parallax-layer {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
      }
      .parallax-background {
        transform: translateZ(-1px) scale(2);
        background: url("https://source.unsplash.com/random/1920x1080?abstract")
          no-repeat center center fixed;
        background-size: cover;
        z-index: -1;
      }
      .content {
        transform: translateZ(0);
        position: relative;
        background-color: rgba(255, 255, 255, 0.9);
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        border-radius: 15px;
        margin: 20px auto;
        padding: 40px;
        max-width: 800px;
      }
      h1 {
        text-align: center;
        font-size: 3em;
        color: #333;
        margin-bottom: 40px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        animation: slideDown 1s ease-out;
      }
      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-50px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .form-group {
        margin-bottom: 20px;
        animation: fadeIn 0.5s ease-out forwards;
        opacity: 0;
      }
      @keyframes fadeIn {
        to {
          opacity: 1;
        }
      }
      .form-group label {
        display: block;
        font-size: 1.2em;
        margin-bottom: 10px;
        color: #2c3e50;
      }
      .form-group input,
      .form-group textarea,
      trix-editor,
      .custom-dropdown {
        width: 100%;
        padding: 10px;
        font-size: 1em;
        border-radius: 5px;
        border: 1px solid #ddd;
        background-color: #f7f7f7;
        box-sizing: border-box;
        transition: all 0.3s ease;
      }
      .form-group input:focus,
      .form-group textarea:focus,
      trix-editor:focus,
      .custom-dropdown:focus {
        border-color: #3498db;
        background-color: #fff;
        outline: none;
        box-shadow: 0 0 10px rgba(52, 152, 219, 0.1);
      }
      trix-editor {
        min-height: 200px;
      }
      .submit-btn {
        display: block;
        width: 100%;
        padding: 15px 30px;
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        color: #fff;
        border: none;
        border-radius: 30px;
        cursor: pointer;
        font-size: 1.2em;
        font-weight: 600;
        transition: all 0.3s ease;
        text-align: center;
        box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        animation: float 3s ease-in-out infinite;
      }
      @keyframes float {
        0% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-10px);
        }
        100% {
          transform: translateY(0px);
        }
      }
      .submit-btn:hover {
        background: linear-gradient(135deg, #2980b9 0%, #3498db 100%);
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
      }
      .emails-list {
        margin-bottom: 20px;
        padding: 15px;
        background-color: #f7f7f7;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }
      .emails-list span {
        display: block;
        color: #3498db;
        margin-bottom: 5px;
        font-size: 0.9em;
      }
      .custom-dropdown {
        padding: 10px;
        font-size: 1em;
        border: 1px solid #ddd;
        border-radius: 5px;
        background-color: #fff;
        margin-bottom: 10px;
        width: 100%;
        cursor: pointer;
      }
      .custom-dropdown:hover {
        border-color: #3498db;
      }
    </style>
  </head>
  <body>
    <div class="parallax-container">
      <div class="parallax-layer parallax-background"></div>
      <div class="parallax-layer content">
        <h1>Send Email</h1>
        <div id="emailsContainer" class="emails-list">
          <!-- Selected emails will be displayed here -->
        </div>
        <form id="emailForm" action="/send-email" method="POST">
          <div class="form-group" style="animation-delay: 0.1s">
            <label for="emailSubject">Subject:</label>
            <input
              type="text"
              id="emailSubject"
              name="subject"
              placeholder="Enter the email subject"
              required
            />
          </div>
          <div class="form-group" style="animation-delay: 0.2s">
            <label for="variableDropdown">Personalize:</label>
            <select id="variableDropdown" class="custom-dropdown">
              <option value="">Select an option</option>
              <option value="{companyName}">Company Name</option>
              <option value="{jobTitle}">Job Title</option>
              <option value="{name}">Name</option>
            </select>
          </div>
          <div class="form-group" style="animation-delay: 0.3s">
            <label for="emailBody">Email Body:</label>
            <input id="emailBody" name="body" type="hidden" />
            <trix-editor input="emailBody"></trix-editor>
          </div>
          <button type="submit" class="submit-btn">Send Email</button>
        </form>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/trix/1.3.1/trix.js"></script>
    <script>
      // Your existing JavaScript code remains unchanged
      document.addEventListener('DOMContentLoaded', (event) => {
        try {
          const emails = JSON.parse(sessionStorage.getItem('emails'));
          console.log(emails);
        } catch (error) {
          console.error('Error parsing emails:', error);
        }
      });

      document.addEventListener('DOMContentLoaded', (event) => {
        // Retrieve the emails from the server-side rendered data
        const emails = <%- JSON.stringify(emails) %>;

        const emailsContainer = document.getElementById('emailsContainer');

        if (emails.length > 0) {
          emails.forEach(email => {
            const emailSpan = document.createElement('span');
            emailSpan.textContent = email;
            emailsContainer.appendChild(emailSpan);
          });
        } else {
          emailsContainer.textContent = 'No emails selected. Please go back and select at least one email.';
        }

        // Store emails in localStorage for use in form submission
        localStorage.setItem('selectedEmails', JSON.stringify(emails));
      });

      document.getElementById("emailForm").onsubmit = function (event) {
        event.preventDefault(); // Prevent the default form submission

        const subject = document.getElementById("emailSubject").value;
        const body = document
          .querySelector("trix-editor")
          .editor.getDocument()
          .toString()
          .trim();

        // Retrieve emails from localStorage
        const emails = JSON.parse(localStorage.getItem('selectedEmails'));

        if (!subject || !body || emails.length === 0) {
          alert("Please fill in the subject, body, and ensure emails are selected.");
          return;
        }

        // Use fetch API to send data to your server
        fetch("/send-email", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ subject: subject, body: body, emails: emails }),
        })
          .then((response) => response.json())
          .then((data) => {
            alert("Email sent successfully!");
            console.log(data);
          })
          .catch((error) => {
            console.error("Error during email sending:", error);
            alert("Failed to send email: " + error.message);
          });
      };

      document.getElementById("variableDropdown").addEventListener("change", function (event) {
        const selectedVariable = event.target.value;
        if (selectedVariable) {
          const editor = document.querySelector("trix-editor").editor;
          const currentPosition = editor.getSelectedRange()[0];
          editor.insertString(selectedVariable);
          editor.setSelectedRange([currentPosition + selectedVariable.length, currentPosition + selectedVariable.length]);
        }
      });
    </script>
  </body>
</html>
